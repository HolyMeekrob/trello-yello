<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib\trelloObj.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/action.html">action</a></li>
                                <li><a href="../classes/board.html">board</a></li>
                                <li><a href="../classes/card.html">card</a></li>
                                <li><a href="../classes/checklist.html">checklist</a></li>
                                <li><a href="../classes/label.html">label</a></li>
                                <li><a href="../classes/list.html">list</a></li>
                                <li><a href="../classes/member.html">member</a></li>
                                <li><a href="../classes/notification.html">notification</a></li>
                                <li><a href="../classes/organization.html">organization</a></li>
                                <li><a href="../classes/token.html">token</a></li>
                                <li><a href="../classes/trello.html">trello</a></li>
                                <li><a href="../classes/trelloObj.html">trelloObj</a></li>
                                <li><a href="../classes/webhook.html">webhook</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/trello-yello.html">trello-yello</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: lib\trelloObj.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
const Promise = require(&#x27;bluebird&#x27;);
const R = require(&#x27;ramda&#x27;);
const hasValidPath = require(&#x27;./util&#x27;).hasValidPath;
const removeNonAutoProperties = require(&#x27;./util&#x27;).removeNonAutoProperties;

/**
 * Base object for Trello objects. All Trello objects inherit from this.
 * Do not use this class directly.
 *
 * @class trelloObj
 * @constructor
 * @private
 * @param {Object} params the constructor parameters object
 * @param {Object} params.maps the container for all Trello object
 * property mappings. Please refer to its documentation for details.
 * @param {String} params.objType the type of Trello object. Please refer to
 * other documentation for the list of allowed types.
 * @param {Object} params.config configuration object
 * @param {String} params.config.key the application key for accessing Trello
 * @param {String} params.config.token a valid Trello API token
 * @param {Number} params.config.version the Trello API version Number
 * @param {String} params.id the ID of the Trello object
 * @param {Object} params.net the network service. Please refer to its
 * documentation for specifics.
 * @param {Function} params.objConstructor the factory method for creating new
 * Trello objects. Using an injected factory method allows us to use higher
 * level object classes while still maximizing reuse with this base object.
 * @param {Object} [params.initialVals] the initial values of the Trello
 * object
 */
const trelloObj = (cParams) =&gt; {
	&#x27;use strict&#x27;;

	const { maps, objType, config, id, net, initialVals, objConstructor } = cParams;

	if (R.any(R.isNil, [config, id, net])) {
		throw new Error(&#x27;Configuration, id, and network service are required.&#x27;);
	}

	if (typeof objConstructor !== &#x27;function&#x27;) {
		throw new Error(&#x27;objConstructor function is required.&#x27;);
	}

	/**
	 * Pointer to the mapping entity for this Trello object type. This mapping
	 * contains all allowable property names and operations for this object type.
	 *
	 * @private
	 * @property trelloPropertyNames
	 * @type Object
	 * @final
	 */
	const trelloPropertyNames = maps[objType].props;

	if (trelloPropertyNames === undefined) {
		throw new Error(&#x27;Invalid object type: &#x27; + objType);
	}

	/**
	 * Stores all of the object&#x27;s Trello properties internally.
	 *
	 * @private
	 * @property trelloProps
	 * @type Object
	 */
	let trelloProps = { id: id };

	// Remove all fields that are themselves Trello objects so that we can
	// construct them properly. Everything else should be copied into this object
	// so as to reduce future network connections.
	trelloProps = R.merge(trelloProps,
			removeNonAutoProperties(initialVals, trelloPropertyNames));

	/**
	 * Expires local data. The next time a get() operation is called, new data
	 * will be retrieved over the network.
	 *
	 * @private
	 * @method expireData
	 * @return {void}
	 */
	const expireData = () =&gt; {
		trelloProps = { id: id };
	};

	/**
	 * Retrieves all of the auto-properties for the Trello object. auto-properties
	 * are properties that can be retrieved as part of the GET operation on the
	 * object itself, and are not themselves Trello objects.
	 *
	 * @private
	 * @method getAutoProperties
	 * @return {Object} a Promise that resolves to an object containing all of the
	 * auto-properties and their values.
	 */
	const getAutoProperties = () =&gt; {
		return net.get(config, objType, trelloProps.id,
				maps[objType].defaultArgs)
				.then(response =&gt; {
					const rawObj = JSON.parse(response.body);
					return Promise.resolve(
							removeNonAutoProperties(rawObj, trelloPropertyNames));
				});
	};

	/**
	 * Retrieves a Trello property on this object that is itselfg a Trello object.
	 *
	 * @private
	 * @method getSubTypeProperty
	 * @param {String} prop the property to retrieve
	 * @param {Object} propData the property mappings for this Trello object
	 * @return {Object} a Promise that resolves to either a trelloObj object or
	 * an array of trelloObj objects
	 */
	const getSubTypeProperty = (prop, propData) =&gt; {
		const trelloType = propData.trelloType;
		const parameters = propData.get;

		return net.get(config, objType, trelloProps.id, parameters, prop)
			.then(response =&gt; {
				const sub = JSON.parse(response.body);

				if (Array.isArray(sub)) {
					return Promise.resolve(sub.map(subObj =&gt;
						objConstructor({
							maps,
							objType: trelloType,
							config,
							id: subObj.id,
							net,
							initialVals: subObj,
							objConstructor
						})
					));
				}
				else {
					return Promise.resolve(objConstructor({
						maps,
						objType: trelloType,
						config,
						id: sub.id,
						net,
						initialVals: sub,
						objConstructor
					}));
				}
			});
	};

	/**
	 * Retrieves a property from the network.
	 *
	 * @private
	 * @method getUnretrievedProperty
	 * @param {String} prop the property to retrieve
	 * @param {Boolean} [skipValidation=false] if true, skips local
	 * validation of the property path
	 * @return a Promise that resolves to the retrieved property.
	 */
	const getUnretrievedProperty = (prop, skipValidation) =&gt; {
		const propExists = trelloPropertyNames.hasOwnProperty(prop);
		const propIsGettable = propExists
				&amp;&amp; trelloPropertyNames[prop].hasOwnProperty(&#x27;get&#x27;);

		if (skipValidation &amp;&amp; !propExists &amp;&amp; !propIsGettable) {
			return net.get(config, objType, trelloProps.id, {}, prop)
					.then(response =&gt; {
						trelloProps[prop] = JSON.parse(response.body);
						return Promise.resolve(trelloProps[prop]);
					});
		}

		// If the property does not exist in the Trello API
		if (!propExists) {
			return Promise.reject(new Error(
					&#x27;Trello Property &#x27; + objType + &#x27;/&#x27; + prop + &#x27; is not valid.&#x27;
			));
		}

		if (!propIsGettable) {
			return Promise.reject(new Error(
					&#x27;Trello Property &#x27; + objType + &#x27;/&#x27; + prop + &#x27; is not gettable.&#x27;
			));
		}

		const propData = trelloPropertyNames[prop];
		if (propData.isAutoProp) {
			return getAutoProperties()
					.then(response =&gt; {
						trelloProps = R.merge(trelloProps, response);
						return Promise.resolve(trelloProps[prop]);
					});
		}

		else if (R.isNil(propData.trelloType)) {
			return net.get(config, objType, trelloProps.id, propData.get, prop)
					.then(response =&gt; {
						trelloProps[prop] = JSON.parse(response.body);
						return Promise.resolve(trelloProps[prop]);
					});
		}

		else {
			return getSubTypeProperty(prop, propData)
					.then(subObj =&gt; {
						trelloProps[prop] = subObj;
						return Promise.resolve(trelloProps[prop]);
					});
		}
	};

	/**
	 * Sets properties on the object with the given values.
	 *
	 * @private
	 * @method
	 * @param {Object} values the values to set on the object. This object is
	 * a mapping of properties supported by the Trello API and their new values.
	 * @param {Boolean} [skipValidation=false] if true, skips local
	 * validation of the property path
	 * @return {Object} a Promise that resolves to a truthy value
	 */
	const setObject = (values, skipValidation) =&gt; {
		if (skipValidation || maps[objType].allowEmptyPut) {
			return net.put(config, objType, trelloProps.id, values)
					.then(res =&gt; {
						expireData();
						return res;
					});
		}

		return Promise.reject(new Error(
				&#x27;Cannot set values on Trello object type &#x27; + objType
		));
	};

	/**
	 * Sets values on a property of the Trello object. Skips local path
	 * validation.
	 *
	 * @private
	 * @method setPropertySkipValidation
	 * @param {Object} values the new values
	 * @param {String} path the path to the property
	 * @param {Boolean} [params.preferNonIdempotence=false] only relevant if
	 * the property can be set in both an idempotent and non-idempotent manner.
	 * If this value is set to true, then the non-idempotent operation will be
	 * used. Otherwise, the operation will be idempotent.
	 * @return {Object} a Promise that resolves to a truthy value
	 */
	const setPropertySkipValidation = (values, path, preferNonIdempotence) =&gt; {
		if (preferNonIdempotence) {
			return net.post(config, objType, trelloProps.id, values, path)
					.then(res =&gt; {
						expireData();
						return res;
					});
		}
		return net.put(config, objType, trelloProps.id, values, path)
					.then(res =&gt; {
						expireData();
						return res;
					});
	};

	/**
	 * Sets values on a property of the Trello object.
	 *
	 * @private
	 * @method setProperty
	 * @param {Object} values the new values
	 * @param {String} path the path to the property. This is a series
	 * of property names and identifiers split by forward slashes (/). If
	 * skipValidation is false, this path must match a mapping in the Trello
	 * object property maps, otherwise this method will resolve to an error.
	 * @param {Boolean} [params.preferNonIdempotence=false] only relevant if
	 * the property can be set in both an idempotent and non-idempotent manner.
	 * If this value is set to true, then the non-idempotent operation will be
	 * used. Otherwise, the operation will be idempotent.
	 * @param {Boolean} [skipValidation=false] if true, skips local
	 * validation of the property path
	 * @return {Object} a Promise that resolves to a truthy value
	 */
	const setProperty = (values, path, preferNonIdempotence, skipValidation) =&gt; {
		if (skipValidation) {
			return setPropertySkipValidation(values, path, preferNonIdempotence);
		}

		const pathElems = path.split(&#x27;/&#x27;).filter(str =&gt; str !== &#x27;&#x27;);

		if (pathElems.length === 0) {
			return Promise.reject(new Error(&#x27;Malformed property path: &#x27; + path));
		}

		if (!trelloPropertyNames.hasOwnProperty(pathElems[0])) {
			return Promise.reject(new Error(
				&#x27;Trello Property &#x27; + objType + &#x27;/&#x27; + path + &#x27; is not valid.&#x27;
			));
		}

		const property = trelloPropertyNames[pathElems[0]];

		let firstVerb;
		let secondVerb;
		if (preferNonIdempotence) {
			firstVerb = &#x27;post&#x27;;
			secondVerb = &#x27;put&#x27;;
		}
		else {
			firstVerb = &#x27;put&#x27;;
			secondVerb = &#x27;post&#x27;;
		}

		const remainingPath = pathElems.slice(1);

		if(property.hasOwnProperty(firstVerb)
				&amp;&amp; hasValidPath(property[firstVerb], remainingPath)) {
			expireData();
			return net[firstVerb](config, objType, trelloProps.id, values, path)
					.then(res =&gt; {
						expireData();
						return res;
					});
		}

		if (property.hasOwnProperty(secondVerb)
				&amp;&amp; hasValidPath(property[secondVerb], remainingPath)) {
			return net[secondVerb](config, objType, trelloProps.id, values, path)
					.then(res =&gt; {
						expireData();
						return res;
					});
		}

		return Promise.reject(new Error(
				&#x27;Trello Property &#x27; + objType + &#x27;/&#x27; + path + &#x27; is not settable.&#x27;
		));
	};

	/**
	 * Deletes the Trello object.
	 *
	 * @private
	 * @method deleteObj
	 * @param {Boolean} [skipValidation=false] if true, skips local validation of
	 * the property path
	 * @return {Object} a Promise that resolves to a truthy value
	 */
	const deleteObj = (skipValidation) =&gt; {
		if (skipValidation || maps[objType].allowDeletion) {
			return net.del(config, objType, trelloProps.id);
		}

		return Promise.reject(new Error(
				&#x27;Object type &#x27; + objType + &#x27; does not allow deletion.&#x27;
		));
	};

	/**
	 * Deletes a property on the Trello object. Skips local path validation.
	 *
	 * @private
	 * @method deleteProperty
	 * @param {String} path the path to the property
	 * @return {Object} a Promise that resolves to a truthy value
	 */
	const deletePropertySkipValidation = (path) =&gt; {
		return net.del(config, objType, trelloProps.id, path)
				.then(res =&gt; {
					expireData();
					return res;
				});
	};

	/**
	 * Deletes a property on the Trello object.
	 *
	 * @private
	 * @method deleteProperty
	 * @param {String} path the path to the property. This is a series
	 * of property names and identifiers split by forward slashes (/). If
	 * skipValidation is false, this path must match a mapping in the Trello
	 * object property maps, otherwise this method will resolve to an error.
	 * @return {Object} a Promise that resolves to a truthy value
	 */
	const deleteProperty = (path, skipValidation) =&gt; {
		if (skipValidation) {
			return deletePropertySkipValidation(path);
		}

		const pathElems = path.split(&#x27;/&#x27;).filter(str =&gt; str !== &#x27;&#x27;);

		if (pathElems.length === 0) {
			return Promise.reject(new Error(&#x27;Malformed property path: &#x27; + path));
		}

		const property = trelloPropertyNames[pathElems[0]];

		if (!property.hasOwnProperty(&#x27;delete&#x27;)) {
			return Promise.reject(new Error(
					&#x27;Trello property &#x27; + path + &#x27; does not allow deletion.&#x27;
			));
		}

		if (!hasValidPath(property.delete, pathElems.slice(1))) {
			return Promise.reject(new Error(
					&#x27;Trello property &#x27; + path + &#x27; does not allow deletion.&#x27;
			));
		}

		return deletePropertySkipValidation(path);
	};

	////////////////////////////////////////////////////////////////////////////
	//															PUBLIC METHODS														//
	////////////////////////////////////////////////////////////////////////////

	/**
	 * Asynchronously retrieves a property value from Trello. If the property
	 * hasn&#x27;t yet been populated, or it is dirty, then a network call to Trello
	 * is made. Otherwise, the property is returned from memory. An error will
	 * be returned if the property doesn&#x27;t exist or is not a gettable property.
	 *
	 * @method get
	 * @param {String} params.propName the name of the property to retrieve
	 * @param {Boolean} [params.skipValidation=false] if true, skips local
	 * validation of the property path
	 * @param {Function} [params.callback] the callback function once the
	 * operation is complete. This is optional, as a Promise is returned.
	 * @return {Object} a Promise that resolves to the property value
	 */
	const get = (params) =&gt; {
		const { propName, callback } = params;

		if (trelloProps[propName] === undefined) {
			return getUnretrievedProperty(propName, params.skipValidation)
					.nodeify(callback);
		}

		return Promise.resolve(trelloProps[propName]).nodeify(callback);
	};

	/**
	 * Gets the id of the Trello object.
	 *
	 * @method getId
	 * @param {Function} [callback] the callback function once the operation is
	 * complete. This is optional, as a Promise is returned.
	 * @return {Object} a Promise that resolves to the id
	 */
	const getId = (callback) =&gt; {
		const args = {
			propName: &#x27;id&#x27;,
			callback
		};
		return get(args);
	};


	/**
	 * Sets the given property using the new values passed in. If a property name
	 * is not included, then the object itself is set using the new values.
	 *
	 * @method set
	 * @param {Object} params the parameters object
	 * @param {Object} [params.values={}] the new values
	 * @param {String} params.propName the name of the property you are setting.
	 * If propName isn&#x27;t included, then params.values is set on the object itself.
	 * @param {Boolean} [params.preferNonIdempotence=false] only relevant when
	 * the given property name can be modified both in an idempotent and a
	 * non-idempotent way. In that case, we default to the idempotent operation.
	 * As an example, if you set the labels on a card in an idempotent way, then
	 * it will replace all of the existing labels with the labels that were
	 * passed in. If you do it in a non-idempotent way, then the passed in labels
	 * will be added to the card, but existing labels will not be modified.
	 * @param {Boolean} [params.skipValidation=false] if true, skips local
	 * validation of the property path
	 * @param {Function} [params.callback] the callback function once the
	 * operation is complete. This is optional, as a Promise is returned.
	 * @return {Object} a Promise that resolves to a truthy value. The exact
	 * nature of this value is currently undefined and may change in the future.
	 */
	const set = (params) =&gt; {
		const { propName, preferNonIdempotence, callback } = params;
		let values = params.values;

		if (R.isNil(values)) {
			values = {};
		}

		if ((typeof values) !== &#x27;object&#x27;) {
			return Promise.reject(new Error(&#x27;Value must be an object.&#x27;))
					.nodeify(callback);
		}

		if (R.isNil(propName)) {
			return setObject(values, params.skipValidation).nodeify(callback);
		}
		else {
			return setProperty(
					values, propName, !!preferNonIdempotence, params.skipValidation)
					.nodeify(callback);
		}
	};

	/**
	 * Deletes the given property. If no property is given, then the Trello
	 * object itself gets deleted.
	 *
	 * @method del
	 * @param {Object} params the method parameters object
	 * @param {String} [params.propName] the property to delete. If this is not
	 * included, then the object itself will be deleted.
	 * @param {Function} [params.callback] the callback function once the
	 * operation is complete. This is optional, as a Promise is returned.
	 * @param {Boolean} [params.skipValidation=false] if true, skips local
	 * validation of the property path
	 * @return {Object} a Promise that resolves to a truthy value. The exact
	 * nature of this value is currently undefined and may change in the future
	 */
	const del = (params) =&gt; {
		let propName;
		let callback;

		if (!R.isNil(params)) {
			propName = params.propName;
			callback = params.callback;
		}

		if (R.isNil(propName)) {
			return deleteObj(params.skipValidation).nodeify(callback);
		}

		return deleteProperty(propName, params.skipValidation).nodeify(callback);
	};

	return Object.freeze({
		get,
		getId,
		set,
		del
	});
};

module.exports = trelloObj;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
